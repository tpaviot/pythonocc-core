version: pythonocc-core-7.4.0beta-dev.{build}

os:
  - Visual Studio 2015
  - macOS
  - Ubuntu

environment:
  binstar_token:
    # below the secure to upload to anaconda cloud
    # take the anaconda token generated from the command line
    # anaconda auth -n the_token_name --max-age 22896000 -c --scopes api
    # and copy paste to
    # https://ci.appveyor.com/tools/encrypt
    # then copy/paste the result below
    secure: 6Wllm3O0zxgpBaBDNMTQAVdcBb9tMylzp72/JlpDQjljxvmF/g8FPSDZaGVs9zR8

  matrix:
    - PYTHON: "C:\\Python36_32"
      PYTHON_VERSION: "3.6"
      PYTHON_ARCH: "32"
      CONDA_PY: "36"
      CONDA_NPY: "18"
      CONDA_INSTALL_LOCN: "C:\\Miniconda36"
    - PYTHON_VERSION: "3.6"
      PYTHON_ARCH: "64"
      CONDA_PY: "36"
      CONDA_NPY: "18"
      CONDA_INSTALL_LOCN: "C:\\Miniconda36-x64"
    - PYTHON_VERSION: "3.7"
      PYTHON_ARCH: "32"
      CONDA_PY: "37"
      CONDA_NPY: "18"
      CONDA_INSTALL_LOCN: "C:\\Miniconda37"
    - PYTHON_VERSION: "3.7"
      PYTHON_ARCH: "64"
      CONDA_PY: "37"
      CONDA_NPY: "18"
      CONDA_INSTALL_LOCN: "C:\\Miniconda37-x64"

install:
    - ps: |
        if ($isLinux) {
          wget "http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh" -O miniconda.sh
        } elseif ($isMacOS) {
          brew install wget
          wget "https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh" -O miniconda.sh
          wget "https://github.com/phracker/MacOSX-SDKs/releases/download/10.13/MacOSX10.9.sdk.tar.xz"  -O MacOSX10.9.sdk.tar.xz
          tar xf MacOSX10.9.sdk.tar.xz
          sudo mv MacOSX10.9.sdk /opt/
          ls /opt
        }
    - sh: bash miniconda.sh -b
    - sh: export PATH=$HOME/miniconda3/bin:$PATH
    # On Windows, activate the environment
    - cmd: call %CONDA_INSTALL_LOCN%\Scripts\activate.bat
    # Following lines are os independant
    - conda config --set always_yes yes --set changeps1 no
    - conda config --set show_channel_urls true
    - conda install conda-build anaconda-client
    - conda config --add channels dlr-sc
    - cmd: set PYTHONBUFFERED=1
    - sh: export PYTHONBUFFERED=1

build: off

test_script:
  - cmd: conda build .\\ci\\conda --quiet --no-remove-work-dir --dirty
  - sh: conda build ./ci/conda --quiet --no-remove-work-dir --dirty
  # move conda package to /dist
  - mkdir dist  # portable command windows/linux
  # upload for osx
  - sh: cp $HOME/miniconda3/conda-bld/osx-64/*.bz2 dist
  - sh: anaconda -t $BINSTAR_TOKEN upload dist/*.bz2 -l cd-$APPVEYOR_REPO_BRANCH --force
  # upload for Windows
  - cmd: copy /Y %CONDA_INSTALL_LOCN%\conda-bld\win-%PYTHON_ARCH%\pythonocc*.bz2 dist || cmd /c "exit /b 0"
  - ps: cmd /C anaconda --token $env:BINSTAR_TOKEN upload  dist\*.bz2 -l cd-$env:APPVEYOR_REPO_BRANCH --force "2>&1"

artifacts:
  - path: dist\*
    name: packages
